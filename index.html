<script>
document.addEventListener('DOMContentLoaded', () => {
    let auth;
    try {
        // Initialize Firebase with the configuration from firebase-config.js
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
    } catch (error) {
        console.error('Firebase initialization error:', error);
        auth = null; // Fallback if initialization fails
    }
    setupEventListeners(auth);

    function setupEventListeners(auth) {
        // DOM Elements
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navLinks = document.getElementById('navLinks');
        const signInBtn = document.getElementById('signInBtn');
        const signUpBtn = document.getElementById('signUpBtn');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const floatingWalletBtn = document.getElementById('connectWallet');
        const signupModal = document.getElementById('signupModal');
        const loginModal = document.getElementById('loginModal');
        const walletModal = document.getElementById('walletModal');
        const showLogin = document.getElementById('showLogin');
        const showSignup = document.getElementById('showSignup');
        const closeBtns = document.querySelectorAll('.close-btn');
        const userDropdown = document.getElementById('userDropdown');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileLink = document.getElementById('profileLink');
        const walletOptions = document.querySelectorAll('.wallet-option');
        const walletStatus = document.getElementById('walletStatus');
        const signupForm = document.getElementById('signupForm');
        const loginForm = document.getElementById('loginForm');
        const googleSignup = document.getElementById('googleSignup');
        const googleLogin = document.getElementById('googleLogin');
        const contactForm = document.getElementById('contactForm');
        const newsletterForm = document.querySelector('.newsletter-form');

        // Modal Handling
        function closeAllModals() {
            [signupModal, loginModal, walletModal].forEach(modal => {
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            if (userDropdown) userDropdown.style.display = 'none';
        }

        function openModal(modal) {
            if (modal) {
                closeAllModals();
                modal.style.display = 'block';
            }
        }

        // Button Event Listeners
        if (signInBtn) {
            signInBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal(loginModal);
            });
        }

        if (signUpBtn) {
            signUpBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal(signupModal);
            });
        }

        if (connectWalletBtn) {
            connectWalletBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal(walletModal);
            });
        }

        if (floatingWalletBtn) {
            floatingWalletBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal(walletModal);
            });
        }

        // Close buttons
        closeBtns.forEach(btn => {
            btn.addEventListener('click', closeAllModals);
        });

        // Toggle between auth modals
        if (showLogin) {
            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                openModal(loginModal);
            });
        }

        if (showSignup) {
            showSignup.addEventListener('click', (e) => {
                e.preventDefault();
                openModal(signupModal);
            });
        }

        // User Authentication State
        let currentUser = null;

        function isLoggedIn() {
            return currentUser !== null;
        }

        // Update UI based on auth state
        function updateUI(user) {
            if (user) {
                currentUser = user;
                const displayName = user.displayName || user.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                if (document.getElementById('userName')) {
                    document.getElementById('userName').textContent = displayName;
                }
                if (document.getElementById('userInitial')) {
                    document.getElementById('userInitial').textContent = initial;
                }
                if (document.getElementById('dashboardName')) {
                    document.getElementById('dashboardName').textContent = displayName;
                }
                if (document.getElementById('dashboardEmail')) {
                    document.getElementById('dashboardEmail').textContent = user.email;
                }
                if (signInBtn) {
                    signInBtn.textContent = displayName;
                    signInBtn.classList.add('user-btn');
                }
                if (signUpBtn) {
                    signUpBtn.style.display = 'none';
                }
                console.log('User logged in:', displayName);
            } else {
                currentUser = null;
                if (signInBtn) {
                    signInBtn.textContent = 'Sign In';
                    signInBtn.classList.remove('user-btn');
                }
                if (signUpBtn) {
                    signUpBtn.style.display = 'block';
                }
                if (userDropdown) {
                    userDropdown.style.display = 'none';
                }
                if (document.getElementById('dashboardName')) {
                    document.getElementById('dashboardName').textContent = '';
                }
                if (document.getElementById('dashboardEmail')) {
                    document.getElementById('dashboardEmail').textContent = '';
                }
                console.log('No user logged in');
            }
        }

        // Firebase Auth State Listener
        if (auth) {
            auth.onAuthStateChanged(user => {
                updateUI(user);
            });
        }

        // Sign Up Form Submission
        if (signupForm) {
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;

                if (auth) {
                    auth.createUserWithEmailAndPassword(email, password)
                        .then(userCredential => {
                            return userCredential.user.updateProfile({
                                displayName: name
                            });
                        })
                        .then(() => {
                            closeAllModals();
                            signupForm.reset();
                            alert('Sign up successful! Welcome to AfriChain.');
                            console.log('User signed up:', email);
                        })
                        .catch(error => {
                            alert('Sign up error: ' + error.message);
                            console.error('Sign up error:', error);
                        });
                }
            });
        }

        // Login Form Submission
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (auth) {
                    auth.signInWithEmailAndPassword(email, password)
                        .then(() => {
                            closeAllModals();
                            loginForm.reset();
                            alert('Login successful!');
                            console.log('User logged in:', email);
                        })
                        .catch(error => {
                            alert('Login error: ' + error.message);
                            console.error('Login error:', error);
                        });
                }
            });
        }

        // Google Sign Up/Login
        const googleProvider = auth && new firebase.auth.GoogleAuthProvider();
        if (googleSignup) {
            googleSignup.addEventListener('click', () => {
                if (auth) {
                    auth.signInWithPopup(googleProvider)
                        .then(() => {
                            closeAllModals();
                            alert('Google sign up successful!');
                            console.log('Google sign up completed');
                        })
                        .catch(error => {
                            alert('Google sign up error: ' + error.message);
                            console.error('Google sign up error:', error);
                        });
                }
            });
        }

        if (googleLogin) {
            googleLogin.addEventListener('click', () => {
                if (auth) {
                    auth.signInWithPopup(googleProvider)
                        .then(() => {
                            closeAllModals();
                            alert('Google login successful!');
                            console.log('Google login completed');
                        })
                        .catch(error => {
                            alert('Google login error: ' + error.message);
                            console.error('Google login error:', error);
                        });
                }
            });
        }

        // Logout
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (auth) {
                    auth.signOut()
                        .then(() => {
                            closeAllModals();
                            alert('Logged out successfully');
                            console.log('User logged out');
                        })
                        .catch(error => {
                            alert('Logout error: ' + error.message);
                            console.error('Logout error:', error);
                        });
                }
            });
        }

        // Wallet Connection Simulation
        if (walletOptions) {
            walletOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const walletType = option.getAttribute('data-wallet');
                    if (walletStatus) {
                        walletStatus.textContent = `Connecting to ${walletType}...`;
                        walletStatus.className = 'wallet-status';
                        console.log(`Attempting to connect to ${walletType}`);

                        setTimeout(() => {
                            const success = Math.random() > 0.2; // 80% success rate
                            if (success) {
                                walletStatus.textContent = `Connected to ${walletType}!`;
                                walletStatus.className = 'wallet-status success';
                                setTimeout(() => closeAllModals(), 1000);
                                console.log(`${walletType} connected successfully`);
                            } else {
                                walletStatus.textContent = `Failed to connect to ${walletType}. Try again.`;
                                walletStatus.className = 'wallet-status error';
                                console.error(`${walletType} connection failed`);
                            }
                        }, 1500);
                    }
                });
            });
        }

        // Mobile Menu Toggle
        if (mobileMenuBtn && navLinks) {
            mobileMenuBtn.addEventListener('click', () => {
                navLinks.classList.toggle('active');
                mobileMenuBtn.querySelector('i').classList.toggle('fa-bars');
                mobileMenuBtn.querySelector('i').classList.toggle('fa-times');
                console.log('Mobile menu toggled');
            });
        }

        // Contact Form Submission
        if (contactForm) {
            contactForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const subject = document.getElementById('subject').value;
                const message = document.getElementById('message').value;

                console.log('Contact Form Submitted:', { name, email, subject, message });
                alert('Thank you for your message! We will get back to you soon.');
                contactForm.reset();
            });
        }

        // Newsletter Form Submission
        if (newsletterForm) {
            newsletterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = newsletterForm.querySelector('input').value;
                console.log('Newsletter Subscription:', email);
                alert('Thank you for subscribing to our newsletter!');
                newsletterForm.reset();
            });
        }

        // Profile Link Navigation
        if (profileLink) {
            profileLink.addEventListener('click', (e) => {
                e.preventDefault();
                closeAllModals();
                window.location.hash = '#dashboard';
                console.log('Navigated to dashboard');
            });
        }

        // Particle Animation
        const particleBg = document.querySelectorAll('.particle-bg');
        particleBg.forEach(bg => {
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 5 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                bg.appendChild(particle);
            }
        });
    }
});
</script>
